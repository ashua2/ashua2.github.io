<!DOCTYPE html>
<html>
    <head>
        <title>Data Visualization of COVID-19 in Chicago</title>
    </head>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-annotation/2.5.1/d3-annotation.min.js" integrity="sha512-iBAeBWWWFb8HqSBcrqcz98iIpuVH1la39dEYHtyQ/pGpeCQTQVvLJOWAuhv2Q7JSHp9k7hWA7sGxU3hHJe+tFg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <body>
        <h1 style="text-align:center;font-family:tahoma;color:darkslategray">Data Visualization of COVID-19 in Chicago</h1>
        <p style="font-family:tahoma">testing</p>

        <div id="linechart"></div>


        <script>
            // svg
            var margin = {top: 10, right: 40, bottom: 100, left: 100};

            width = 960 - margin.left - margin.right;
            height = 500 - margin.top - margin.bottom; 

            var svg = d3.select("#linechart")
                .append("svg")
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", height + margin.top + margin.bottom)
                .append("g")
                    .attr("transform","translate(" + margin.left + "," + margin.top + ")");

            // dataset cleaning + storing

            var parseTime = d3.timeParse('%m-%d%-%Y');

            d3.csv("https://gist.githubusercontent.com/ashua2/c369a7bbca9311c50632a9a9c138f30d/raw/a381a14cc3838487451cc90cb5b9476c6e4cca3d/covid_deaths_cases_by_race.csv").then(function(dataset) {
                console.log(dataset);
                var dates_deaths_race = [];

                dataset.forEach(function(data) {
                    data.cases_female = +data.cases_female;
                    data.deathsTotal = +data.deathsTotal,
                    data.casesTotal = +data.casesTotal
                    data.hospitalizationsTotal = +data.hospitalizationsTotal;
                    data.cases_0_17 = +data.cases_0_17;
                    data.cases_18_29 = +data.cases_18_29;
                    data.cases_30_39 = +data.cases_30_39;
                    data.cases_40_49 = +data.cases_40_49;
                    data.cases_50_59 = +data.cases_50_59;
                    data.cases_60_69 = +data.cases_60_69;
                    data.cases_70_79 = +data.cases_70_79;
                    data.cases_80 = +data.cases_80;

                    let race_deaths = {
                        "date": new Date(+(data.date.slice(6)), +(data.date.slice(0,2) - 1), +(data.date.slice(3,5))),
                        "latinx_deaths": +data.deaths_latinx,
                        "asian_deaths": +data.deaths_asian_nonlat,
                        "black_deaths": +data.deaths_black_nonlat,
                        "white_deaths": +data.deaths_white_nonlat,
                        "other_deaths": +data.deaths_other_nonlat
                    }
                    if (race_deaths.date <= new Date(2021, 2, 1) && race_deaths.date >= new Date(2020, 2, 1)) {
                        dates_deaths_race.push(race_deaths);
                    }
                    
                });

                dates_deaths_race.sort(function(o1,o2){
                    return o1.date - o2.date;
                });

                console.log(dates_deaths_race);

            // creating axes + labels

                var dates_x_axis = d3.scaleTime()
                    .domain([new Date(2020, 2, 1), new Date(2021, 2, 1)])
                    .range([0, width]);

                var deaths_y_axis = d3.scaleLinear()
                    .domain([0, 30])
                    .range([height, 0]);
                
                d3.select("svg").append("g")
                    .attr("transform","translate(75,30)")
                    .call(d3.axisLeft(deaths_y_axis));

                d3.select("svg").append("g")
                    .attr("transform","translate(75," + (height + margin.top + 20) + ")")
                    .call(d3.axisBottom(dates_x_axis));
                
                svg.append('text')
                    .attr('x', width/2).attr('y', height + 65).attr('text-anchor', 'middle')
                    .style('font-family', 'tahoma').style('font-size', 15)
                    .text('Month');

                svg.append('text')
                    .attr('text-anchor', 'middle').attr('transform', 'translate(-60,' + height/2 + ')rotate(-90)')
                    .style('font-family', 'tahoma').style('font-size', 15)
                    .text('Deaths');

            // colored lines

                svg.append("path")
                    .datum(dates_deaths_race)
                    .attr("fill", "none")
                    .attr("stroke", "cornflowerblue")
                    .attr("stroke-width", 1.5)
                    .attr("d", d3.line()
                        .x(function(d) { return dates_x_axis(d.date) - margin.right/2 })
                        .y(function(d) { return deaths_y_axis(d.latinx_deaths) + margin.top*2 }));

                svg.append("path")
                    .datum(dates_deaths_race)
                    .attr("fill", "none")
                    .attr("stroke", "violet")
                    .attr("stroke-width", 1.5)
                    .attr("d", d3.line()
                        .x(function(d) { return dates_x_axis(d.date) - margin.right/2 })
                        .y(function(d) { return deaths_y_axis(d.asian_deaths) + margin.top*2 }));

                svg.append("path")
                    .datum(dates_deaths_race)
                    .attr("fill", "none")
                    .attr("stroke", "orange")
                    .attr("stroke-width", 1.5)
                    .attr("d", d3.line()
                        .x(function(d) { return dates_x_axis(d.date) - margin.right/2 })
                        .y(function(d) { return deaths_y_axis(d.black_deaths) + margin.top*2 }));

                svg.append("path")
                    .datum(dates_deaths_race)
                    .attr("fill", "none")
                    .attr("stroke", "crimson")
                    .attr("stroke-width", 1.5)
                    .attr("d", d3.line()
                        .x(function(d) { return dates_x_axis(d.date) - margin.right/2 })
                        .y(function(d) { return deaths_y_axis(d.white_deaths) + margin.top*2 }));

                svg.append("path")
                    .datum(dates_deaths_race)
                    .attr("fill", "none")
                    .attr("stroke", "mediumaquamarine")
                    .attr("stroke-width", 1.5)
                    .attr("d", d3.line()
                        .x(function(d) { return dates_x_axis(d.date) - margin.right/2 })
                        .y(function(d) { return deaths_y_axis(d.other_deaths) + margin.top*2 }));

            // legend

                var races = ["Black", "Asian", "Latinx", "White", "Other"];
                var colors = ["orange", "violet", "cornflowerblue", "crimson", "mediumaquamarine"];

                svg.selectAll("legenddots")
                    .data(colors).enter().append("circle")
                        .attr("cx", 750)
                        .attr("cy", function(d,i) {return 45 + i*20;})
                        .attr("r", 3)
                        .style("fill", function(d,i) {return d;});
                
                svg.selectAll("legendlabels")
                    .data(races).enter().append("text")
                        .attr("x", 765)
                        .attr("y", function(d,i) {return 45 + i*20;})
                        .attr("alignment-baseline","middle")
                        .text(function(d) {return d;})
                        .style("font-size", "13px").style("font-family", "tahoma");

            // tooltip

                var Tooltip = d3.select("#linechart")
                    .append("div")
                    .style("opacity", 0)
                    .attr("class", "tooltip")
                    .style("background-color", "white")
                    .style("border", "solid")
                    .style("border-width", "2px")
                    .style("border-radius", "5px")
                    .style("padding", "5px");

                var mouseover = function(d) {
                    Tooltip
                        .style("opacity", 1)
                    d3.select(this)
                        .style("stroke", "black")
                        .style("opacity", 1);
                }

                var mousemove = function(d) {
                    Tooltip
                        .html("<b>Deaths on "+d.date+":</b><br>Black: "+d.black_deaths+"<br>Asian: "+d.asian_deaths+"<br>Latinx: "+d.latinx_deaths+"<br>White: "+d.white_deaths+"<br>Other: "+d.other_deaths)
                        .style("left", (d3.mouse(this)[0]+70) + "px")
                        .style("top", (d3.mouse(this)[1]) + "px");
                }

                var mouseleave = function(d) {
                    Tooltip
                        .style("opacity", 0)
                    d3.select(this)
                        .style("stroke", "none")
                        .style("opacity", 1);
                }


            });
        </script>
    </body>
</html>